<!-- SRA Research Associate Fragment // v4.2.0.0 -->
<div class="grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card span-full" style="grid-column: span 2;">
        <div class="card-header" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <h3 class="card-title" style="margin: 0; border: none; padding-left: 0;">DEEP_RESEARCH_PROMPT</h3>
            <span class="badge badge-leech">Lattice Mode: ACTIVE</span>
        </div>
        <div class="card-content">
            <div style="display: flex; gap: 15px;">
                <input type="text" id="research-query" placeholder="Enter research query for Revelation Engine..."
                    style="flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: #fff; padding: 1.2rem; border-radius: 12px; outline: none; font-family: inherit;">
                <button class="btn btn-primary btn-evolution" id="research-btn"
                    onclick="runResearch()">INITIATE_REVELATION</button>
            </div>
        </div>
    </div>

    <!-- Leech Lattice Slice Visualizer -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <h3 class="card-title" style="margin: 0; border: none; padding-left: 0;">LEECH_LATTICE_SLICE</h3>
            <span class="badge badge-hd">196560 NODES</span>
        </div>
        <div class="card-content">
            <div
                style="position: relative; height: 180px; display: flex; align-items: center; justify-content: center;">
                <canvas id="leech-canvas" width="180" height="180" style="position: absolute;"></canvas>
                <div class="resonance-label" style="z-index: 1; text-align: center; pointer-events: none;">
                    <span id="coherence-value"
                        style="font-size: 1.4rem; display: block; font-family: 'JetBrains Mono';">0.00000</span>
                    <span style="font-size: 0.6rem; color: var(--neon-gold); letter-spacing: 1px;">τ_RESONANCE</span>
                </div>
            </div>
            <div style="margin-top: 1.5rem;">
                <ul id="lattice-anchors"
                    style="list-style: none; padding: 0; font-size: 0.7rem; color: #94a3b8; font-family: 'JetBrains Mono';">
                </ul>
            </div>
        </div>
    </div>

    <!-- Reliability Report -->
    <div class="card">
        <div class="card-header" style="margin-bottom: 15px;">
            <h3 class="card-title" style="margin: 0; border: none; padding-left: 0;">RELIABILITY_REPORT</h3>
        </div>
        <div class="card-content" id="reliability-report">
            <div style="color: #64748b; font-size: 0.8rem; text-align: center; padding: 3rem;">
                Awaiting research trigger...
            </div>
        </div>
    </div>

    <!-- Output results -->
    <div class="card span-full" style="grid-column: span 2;">
        <div class="card-header" style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <h3 class="card-title" style="margin: 0; border: none; padding-left: 0;">OUTPUT_CONTRACT_MANIFEST</h3>
            <span class="badge badge-e8">Alethia Verified</span>
        </div>
        <div class="card-content" id="research-results">
            <div style="color: #64748b; font-size: 0.9rem; text-align: center; padding: 4rem;">
                No research cycles initiated.
            </div>
        </div>
    </div>
</div>

<script>
    async function runResearch() {
        const query = document.getElementById('research-query').value;
        const btn = document.getElementById('research-btn');
        if (!query) return;

        btn.disabled = true;
        btn.innerText = 'PROCESSING...';
        const resultsContainer = document.getElementById('research-results');
        resultsContainer.innerHTML = '<div style="text-align: center; padding: 4rem;"><div class="status-dot processing"></div><p style="margin-top: 1rem; color: var(--neon-gold); font-family: Orbitron;">REVEAL_ENGINE_ACTIVE: Generating...</p></div>';

        try {
            const response = await fetch('/api/research', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const data = await response.json();
            displayResults(data);
        } catch (e) {
            resultsContainer.innerHTML = '<div style="color: #ff4444; padding: 2rem;">REVELATION_FAILURE: Connection Error.</div>';
        } finally {
            btn.disabled = false;
            btn.innerText = 'INITIATE_REVELATION';
        }
    }

    function displayResults(data) {
        const tau = data.coherence;
        document.getElementById('coherence-value').innerText = tau.toFixed(5);
        animateLeechSlice(tau);

        const reliabilityReport = document.getElementById('reliability-report');
        reliabilityReport.innerHTML = `
            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #cbd5e1;">
                <p><span style="color:var(--neon-blue)">CHAIN:</span> ${data.providerChain}</p>
                <p><span style="color:var(--neon-purple)">EPIPHANIES:</span> ${data.epiphanyCount}</p>
                <p><span style="color:var(--neon-pink)">LATENCY:</span> ${data.reliability.totalLatencyMs}ms</p>
                <p><span style="color:var(--neon-gold)">FALLBACKS:</span> ${data.reliability.fallbackCount}</p>
            </div>
        `;

        const resultsContainer = document.getElementById('research-results');
        let html = '<div class="revelation-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">';
        data.epiphanies.forEach((epi, i) => {
            html += `
                <div class="revelation-card">
                    <div class="epiphany-header">
                        <h3>EPIPHANY_${String(i + 1).padStart(2, '0')}</h3>
                        <span class="reliability-tag">τ: ${epi.coherence.toFixed(2)}</span>
                    </div>
                    <div class="revelations-list">
                        ${epi.revelations.map(rev => `
                            <div style="margin-bottom: 10px; padding: 12px; border-left: 2px solid var(--neon-blue); background: rgba(255,255,255,0.02); border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.65rem; color: var(--neon-gold); margin-bottom: 6px;">
                                    <span>REVELATION</span>
                                    <span>${rev.emotionalTag}</span>
                                </div>
                                <p style="font-size: 0.85rem; line-height: 1.5; color: #cbd5e1; margin: 0;">${rev.content}</p>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;">
                        ${epi.ahaVectors.map(aha => `<span class="aha-badge">AHA: ${aha}</span>`).join('')}
                    </div>
                </div>
            `;
        });
        html += '</div>';

        // Novelty & Opportunity
        html += '<div style="margin-top: 3rem; border-top: 1px solid var(--glass-border); padding-top: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">';
        html += '<div><h4 style="margin-bottom: 15px; font-size: 0.9rem; color: var(--neon-gold); font-family: Orbitron;">NOVELTY_PROPOSALS</h4>';
        data.noveltyProposals.forEach(p => html += `<div class="card" style="margin-bottom: 10px; padding: 1rem; border-radius: 12px; font-size: 0.85rem;">${p}</div>`);
        html += '</div>';
        html += '<div><h4 style="margin-bottom: 15px; font-size: 0.9rem; color: var(--neon-green); font-family: Orbitron;">OPPORTUNITY_ALERTS</h4>';
        data.opportunityAlerts.forEach(p => html += `<div class="card" style="margin-bottom: 10px; padding: 1rem; border-radius: 12px; border-color: var(--neon-green); background: rgba(57,255,20,0.05); font-size: 0.85rem;">${p}</div>`);
        html += '</div></div>';

        resultsContainer.innerHTML = html;

        // IDE Manifestation
        const appPanel = document.createElement('div');
        appPanel.className = 'card';
        appPanel.style.marginTop = '2rem';
        appPanel.style.borderColor = 'var(--neon-blue)';
        appPanel.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title" style="margin:0; border:none; padding:0;">REVELATION_IDE_v4.2</h3>
                <button class="btn btn-evolution" onclick="manifestApp('${data.task.replace(/'/g, "\\'")}')">MANIFEST_APP</button>
            </div>
            <div id="ide-output" style="margin-top: 20px; display: none;">
                <pre id="code-viewer" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: #cbd5e1; overflow-x: auto; max-height: 400px; border: 1px solid var(--glass-border);"></pre>
                <div id="app-link-container" style="margin-top: 15px;"></div>
            </div>
        `;
        resultsContainer.appendChild(appPanel);

        // Lattice Anchors
        const anchorsList = document.getElementById('lattice-anchors');
        anchorsList.innerHTML = data.leechLatticeSlice.orbits.map(o => `<li style="margin-bottom: 4px;">${o.angle}°: ${o.anchor}</li>`).join('');
    }

    async function manifestApp(query) {
        const ideOutput = document.getElementById('ide-output');
        const codeViewer = document.getElementById('code-viewer');
        const linkContainer = document.getElementById('app-link-container');
        ideOutput.style.display = 'block';
        codeViewer.innerText = "// Manifesting PWA substrate v4.2...";

        try {
            const response = await fetch('/api/app/manifest', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'SRA_SOVEREIGN_2026' },
                body: JSON.stringify({ app_id: `app_${Date.now()}`, prompt: query })
            });
            const result = await response.json();
            const htmlRes = await fetch(result.url);
            codeViewer.innerText = await htmlRes.text();
            linkContainer.innerHTML = `<a href="${result.url}" target="_blank" class="btn btn-evolution" style="text-decoration:none; display:inline-block;">RUN_APPLICATION</a>`;
        } catch (e) {
            codeViewer.innerText = `[ERROR] ${e.message}`;
        }
    }

    const canvas = document.getElementById('leech-canvas');
    const ctx = canvas.getContext('2d');
    let animationId = null;

    function animateLeechSlice(coherence) {
        if (animationId) cancelAnimationFrame(animationId);
        let angle = 0;
        const particles = Array.from({ length: 48 }, (_, i) => ({
            r: 30 + Math.random() * 50, theta: (i / 48) * Math.PI * 2, size: 1.5 + Math.random() * 1.5, colorIdx: i % 2
        }));
        const draw = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(angle);
            ctx.strokeStyle = `rgba(255, 215, 0, ${0.1 + (coherence || 0.1) * 0.3})`;
            [40, 65, 85].forEach(radius => {
                ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2); ctx.stroke();
            });
            particles.forEach(p => {
                ctx.fillStyle = p.colorIdx === 0 ? '#ffd700' : '#00f2ff';
                ctx.globalAlpha = 0.5 + Math.random() * 0.5;
                ctx.beginPath(); ctx.arc(p.r * Math.cos(p.theta), p.r * Math.sin(p.theta), p.size, 0, Math.PI * 2); ctx.fill();
            });
            ctx.restore();
            angle += 0.005 + ((coherence || 0.1) * 0.015);
            animationId = requestAnimationFrame(draw);
        };
        draw();
    }
    animateLeechSlice(0.1);
</script>