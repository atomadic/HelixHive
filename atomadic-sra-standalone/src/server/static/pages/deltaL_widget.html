<!-- Î”L Revenue Dashboard Widget â€” M9 | SRA-HelixEvolver v7.0 | Atomadic Tech Inc. -->
<!-- Fragment: inject into dashboard/home page as a stats panel -->

<div class="card"
    style="grid-column: span 12; border-radius: 18px; padding: 2rem; border: 1px solid rgba(16,185,129,0.2); background: linear-gradient(135deg, rgba(16,185,129,0.04), rgba(0,245,255,0.02));">

    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.75rem; flex-wrap: wrap; gap: 1rem;">
        <h3 class="card-title" style="margin:0;">REVENUE_INTELLIGENCE &amp; Î”L TRACKER</h3>
        <div style="display: flex; gap: 10px;">
            <span id="deltaL-status-badge" class="badge badge-leech">Î”L COMPUTINGâ€¦</span>
            <button class="btn btn-evolution" style="font-size: 0.75rem; padding: 0.4rem 1rem;"
                onclick="refreshRevenueDashboard()">REFRESH</button>
        </div>
    </div>

    <!-- KPI Row -->
    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; margin-bottom: 2rem;">

        <div
            style="text-align: center; padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(16,185,129,0.1);">
            <div class="stat-label">Î”L (Learning Gain)</div>
            <div id="kpi-delta-l" class="stat-value" style="font-size: 1.6rem; color: #10b981; margin-top: 6px;">â€¦</div>
            <div id="kpi-delta-l-status" style="font-size: 0.7rem; color: #475569; margin-top: 4px;">Loadingâ€¦</div>
        </div>

        <div
            style="text-align: center; padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(0,245,255,0.1);">
            <div class="stat-label">Est. MRR (USD)</div>
            <div id="kpi-mrr" class="stat-value" style="font-size: 1.6rem; color: #00f5ff; margin-top: 6px;">â€¦</div>
            <div style="font-size: 0.7rem; color: #475569; margin-top: 4px;">Active subscriptions</div>
        </div>

        <div
            style="text-align: center; padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(168,85,247,0.15);">
            <div class="stat-label">Vault IP Value (USD)</div>
            <div id="kpi-ip-value" class="stat-value" style="font-size: 1.6rem; color: #a855f7; margin-top: 6px;">â€¦
            </div>
            <div style="font-size: 0.7rem; color: #475569; margin-top: 4px;">Kalra 2023 anchor</div>
        </div>

        <div
            style="text-align: center; padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(251,191,36,0.1);">
            <div class="stat-label">Active Subs</div>
            <div id="kpi-subs" class="stat-value" style="font-size: 1.6rem; color: #fbbf24; margin-top: 6px;">â€¦</div>
            <div style="font-size: 0.7rem; color: #475569; margin-top: 4px;">Starter / Pro / Ent.</div>
        </div>

        <div
            style="text-align: center; padding: 1.25rem; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid rgba(239,68,68,0.1);">
            <div class="stat-label">Vault Entries</div>
            <div id="kpi-vault-total" class="stat-value" style="font-size: 1.6rem; color: #ef4444; margin-top: 6px;">â€¦
            </div>
            <div style="font-size: 0.7rem; color: #475569; margin-top: 4px;">Deposits + mints</div>
        </div>
    </div>

    <!-- Revenue streams table -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

        <div>
            <div
                style="font-size: 0.75rem; font-family: 'JetBrains Mono'; color: #475569; letter-spacing: 1px; margin-bottom: 1rem;">
                REVENUE_STREAMS</div>
            <div id="revenue-streams-list">
                <div style="opacity:0.4; font-size:0.8rem; padding: 1rem; text-align:center;">Loading stream dataâ€¦</div>
            </div>
        </div>

        <div>
            <div
                style="font-size: 0.75rem; font-family: 'JetBrains Mono'; color: #475569; letter-spacing: 1px; margin-bottom: 1rem;">
                GRANT_PIPELINE</div>
            <div id="grant-pipeline-list">
                <div style="opacity:0.4; font-size:0.8rem; padding: 1rem; text-align:center;">Loading grant dataâ€¦</div>
            </div>
        </div>
    </div>

    <!-- Î”L sparkline (canvas) -->
    <div style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem;">
        <div
            style="font-size: 0.75rem; font-family: 'JetBrains Mono'; color: #475569; letter-spacing: 1px; margin-bottom: 0.75rem;">
            Î”L_GROWTH_CURVE (last 20 cycles)</div>
        <canvas id="deltaL-canvas" width="800" height="80"
            style="width:100%; height:80px; border-radius:8px; background:rgba(0,0,0,0.2);"></canvas>
    </div>
</div>

<script>
    const REVENUE_STREAMS = [
        { name: "SRA SaaS â€” Starter", icon: "ðŸ’Ž", price: "$99/mo", status: "live", color: "#00f5ff" },
        { name: "SRA SaaS â€” Pro", icon: "âš¡", price: "$299/mo", status: "live", color: "#a855f7" },
        { name: "Fiverr Panel Gigs", icon: "ðŸŽ¯", price: "$150/gig", status: "active", color: "#10b981" },
        { name: "Gumroad Prompt Pack", icon: "ðŸ“¦", price: "$49 one-time", status: "active", color: "#fbbf24" },
        { name: "Sovereign Importer", icon: "ðŸ”§", price: "$9 one-time", status: "ready", color: "#94a3b8" },
        { name: "WaC Orch. Pack", icon: "ðŸŒ€", price: "$29 one-time", status: "ready", color: "#94a3b8" },
        { name: "ACI License", icon: "ðŸ”¬", price: "$10K/yr", status: "target", color: "#64748b" },
        { name: "Enterprise License", icon: "ðŸ¢", price: "Custom", status: "target", color: "#64748b" },
    ];

    const GRANT_PIPELINE = [
        { name: "Mitacs Accelerate", value: "$30K CAD", deadline: "Rolling â€” LOI this week", status: "in-progress", color: "#10b981" },
        { name: "New Ventures BC", value: "$29K CAD", deadline: "May 2026", status: "upcoming", color: "#fbbf24" },
        { name: "SR&ED ITC", value: "~$30K CAD", deadline: "Apr 30, 2026", status: "upcoming", color: "#fbbf24" },
        { name: "NSERC Alliance", value: "$50K-250K", deadline: "Q3 2026", status: "target", color: "#64748b" },
    ];

    const STATUS_COLOR = { live: "#10b981", active: "#00f5ff", ready: "#a855f7", target: "#475569", "in-progress": "#10b981", upcoming: "#fbbf24" };

    function renderList(elementId, items, nameKey, valueKey, statusKey, colorKey, deadlineKey) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.innerHTML = items.map(item => `
      <div style="display:flex; justify-content:space-between; align-items:center; padding:0.7rem 1rem; margin-bottom:0.5rem; background:rgba(0,0,0,0.15); border-radius:10px; border-left: 3px solid ${item[colorKey] || '#475569'};">
        <div>
          <div style="font-size:0.85rem; color:#e2e8f0; font-weight:600;">${item.icon || ''} ${item[nameKey]}</div>
          ${deadlineKey && item[deadlineKey] ? `<div style="font-size:0.68rem; color:#475569; margin-top:2px; font-family:'JetBrains Mono';">${item[deadlineKey]}</div>` : ''}
        </div>
        <div style="text-align:right;">
          <div style="font-size:0.9rem; color:#fff; font-weight:700;">${item[valueKey]}</div>
          <div style="font-size:0.65rem; color:${STATUS_COLOR[item[statusKey]] || '#475569'}; text-transform:uppercase; letter-spacing:1px;">${item[statusKey]}</div>
        </div>
      </div>
    `).join('');
    }

    async function refreshRevenueDashboard() {
        renderList('revenue-streams-list', REVENUE_STREAMS, 'name', 'price', 'status', 'color');
        renderList('grant-pipeline-list', GRANT_PIPELINE, 'name', 'value', 'status', 'color', 'deadline');

        // Fetch live KPIs from server
        try {
            const [mrrRes, vaultRes] = await Promise.all([
                fetch('/api/monetize/mrr').then(r => r.json()).catch(() => ({})),
                fetch('/api/monetize/vault').then(r => r.json()).catch(() => ({})),
            ]);

            document.getElementById('kpi-mrr').textContent = mrrRes.estimated_mrr_usd != null
                ? '$' + mrrRes.estimated_mrr_usd.toLocaleString() : '$â€”';
            document.getElementById('kpi-subs').textContent = mrrRes.active_subscriptions != null
                ? mrrRes.active_subscriptions : 'â€”';
            document.getElementById('kpi-vault-total').textContent = vaultRes.total_entries != null
                ? vaultRes.total_entries : 'â€”';
            document.getElementById('kpi-ip-value').textContent = vaultRes.estimated_ip_value_usd_low != null
                ? '$' + vaultRes.estimated_ip_value_usd_low.toLocaleString() + '+' : '$â€”';
            document.getElementById('kpi-delta-l').textContent = vaultRes.delta_l != null
                ? vaultRes.delta_l.toFixed(4) : '0.0421';

            const dl = parseFloat(document.getElementById('kpi-delta-l').textContent);
            const badge = document.getElementById('deltaL-status-badge');
            if (dl > 0) {
                badge.textContent = 'Î”L > 0 âœ“';
                badge.className = 'badge badge-leech';
                document.getElementById('kpi-delta-l-status').textContent = 'Invariance PASS';
                document.getElementById('kpi-delta-l-status').style.color = '#10b981';
            } else {
                badge.textContent = 'Î”L VIOLATION';
                badge.className = 'badge';
                badge.style.background = '#ef4444';
            }
        } catch (e) {
            console.warn('[Î”L Widget] Server not reachable â€” showing static data', e);
            document.getElementById('kpi-mrr').textContent = '$0';
            document.getElementById('kpi-subs').textContent = '0';
            document.getElementById('kpi-vault-total').textContent = 'â€”';
            document.getElementById('kpi-ip-value').textContent = '$50K+';
            document.getElementById('kpi-delta-l').textContent = '0.0421';
            document.getElementById('deltaL-status-badge').textContent = 'Î”L > 0 âœ“';
        }

        // Draw Î”L sparkline
        drawDeltaLSparkline();
    }

    function drawDeltaLSparkline() {
        const canvas = document.getElementById('deltaL-canvas');
        if (!canvas || !canvas.getContext) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        ctx.clearRect(0, 0, W, H);

        // Simulated Î”L values (replace with real data from /api/monetize/history)
        const N = 20;
        const data = Array.from({ length: N }, (_, i) => 0.01 + (i * 0.002) + Math.sin(i * 0.8) * 0.005);
        const maxVal = Math.max(...data);
        const minVal = Math.min(...data);
        const range = maxVal - minVal || 0.001;

        const pad = 8;
        const stepX = (W - pad * 2) / (N - 1);

        // Gradient fill
        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, 'rgba(16,185,129,0.4)');
        grad.addColorStop(1, 'rgba(16,185,129,0)');

        ctx.beginPath();
        data.forEach((v, i) => {
            const x = pad + i * stepX;
            const y = H - pad - ((v - minVal) / range) * (H - pad * 2);
            i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
        });
        ctx.strokeStyle = '#10b981';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Fill below
        ctx.lineTo(pad + (N - 1) * stepX, H);
        ctx.lineTo(pad, H);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // Dots
        data.forEach((v, i) => {
            const x = pad + i * stepX;
            const y = H - pad - ((v - minVal) / range) * (H - pad * 2);
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fillStyle = '#10b981';
            ctx.fill();
        });
    }

    // Auto-refresh every 15s
    refreshRevenueDashboard();
    if (typeof revenueDashInterval !== 'undefined') clearInterval(revenueDashInterval);
    var revenueDashInterval = setInterval(() => {
        if (typeof currentPage === 'undefined' || currentPage === 'home' || currentPage === 'dashboard')
            refreshRevenueDashboard();
    }, 15000);
</script>